#!/usr/bin/env python
# coding: utf-8

# In[7]:


import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime, timedelta
import numpy as np
from matplotlib import rcParams
from PIL import Image, ImageDraw, ImageFont


# In[8]:


def preparing(data):
    data = data.copy()
    data = data[data['–°—Ç–∞—Ç—É—Å'] == "OK"]
    data['–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏'] = pd.to_datetime(data['–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏'].str.split().str[0], format='%d.%m.%Y', errors='coerce')
    data['–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞'] = pd.to_datetime(data['–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞'].str.split().str[0], format='%d.%–º.%Y', errors='coerce')
    
    numeric_columns = ['–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏', '–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞', '–ë–æ–Ω—É—Å—ã (–≤–∫–ª—é—á–∞—è –∫—ç—à–±—ç–∫)', 
                       '–û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –Ω–∞ –∏–Ω–≤–µ—Å—Ç–∫–æ–ø–∏–ª–∫—É', '–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º']
    
    for column in numeric_columns:
        data[column] = data[column].str.replace(',', '.', regex=False)
        data[column] = pd.to_numeric(data[column], errors='coerce')
    
    data['–ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è'] = data['–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏'].apply(lambda x: x if x > 0 else 0)
    data['–¢—Ä–∞—Ç—ã'] = data['–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏'].apply(lambda x: -x if x < 0 else 0)

    return data



def filter_by_date(data):
    end_date = datetime.now()
    start_date = end_date - timedelta(days=30)

    filtered_data = data[(data['–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏'] >= start_date) & (data['–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏'] <= end_date)]
    
    df = filtered_data.groupby('–ö–∞—Ç–µ–≥–æ—Ä–∏—è', as_index=False).agg({'–¢—Ä–∞—Ç—ã' : 'sum'})
    total = df['–¢—Ä–∞—Ç—ã'].sum()
    df['percent'] = df['–¢—Ä–∞—Ç—ã'] / total * 100
    df = df[df['–¢—Ä–∞—Ç—ã'] > 0]
    df = df.nlargest(5, '–¢—Ä–∞—Ç—ã')
    df = df.sort_values(by='–¢—Ä–∞—Ç—ã', ascending=False)
    df = df.rename(columns={'–ö–∞—Ç–µ–≥–æ—Ä–∏—è':'category', '–¢—Ä–∞—Ç—ã':'amount'})
    return df


def advicing(adv):
    res = []
    for index, row in adv.iterrows():
        cat = row['category']
        s = round(row['amount'], 2)
        perc = round(row['percent'])
        if cat != '–ü–µ—Ä–µ–≤–æ–¥—ã' and cat != '–ù–∞–ª–∏—á–Ω—ã–µ' and cat != '–£—Å–ª—É–≥–∏ –±–∞–Ω–∫–∞' and cat.lower().find('–ø—Ä–æ—Ü–µ–Ω—Ç') == -1:
            if cat == '–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç—ã':
                message = '''üí∏–í –ø—Ä–æ—à–ª–æ–º –º–µ—Å—è—Ü–µ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ***–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç—ã*** –í—ã –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ ***{}*** —Ä—É–±–ª–µ–π - —ç—Ç–æ {}% –æ—Ç –≤—Å–µ—Ö —Ç—Ä–∞—Ç.\n\n\t–í–æ–∑–º–æ–∂–Ω–æ, –í–∞–º —Å—Ç–æ–∏—Ç –ø—Ä–∏—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è –∫ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Å–Ω–∏–∑–∏—Ç—å —Ç—Ä–∞—Ç—ã.\n\n\t–†–µ–∫–æ–º–µ–Ω–¥—É—é –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ö–æ—Ä–æ—à–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∫—ç—à–±—ç–∫–∞ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö ***–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç—ã*** –∏ ***–î–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã*** –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –≤–∞—à–µ–≥–æ –±–∞–Ω–∫–∞.\n\n\t–ê —Ç–∞–∫–∂–µ –ø—Ä–µ–¥–ª–∞–≥–∞—é –≤–∞–º –≤—ã–¥–µ–ª–∏—Ç—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—É–º–º—É, –∫–æ—Ç–æ—Ä—É—é –í—ã —Å–º–æ–∂–µ—Ç–µ —Ç—Ä–∞—Ç–∏—Ç—å –Ω–∞ —ç—Ç—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞ –Ω–µ–¥–µ–ª—é!'''.format(s, perc)
            elif cat == '–°–≤—è–∑—å':
                message = '''üí∏–í –ø—Ä–æ—à–ª–æ–º –º–µ—Å—è—Ü–µ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ***–°–≤—è–∑—å*** –í—ã –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ ***{}*** —Ä—É–±–ª–µ–π - —ç—Ç–æ {}% –æ—Ç –≤—Å–µ—Ö —Ç—Ä–∞—Ç.\n\n\t–í–æ–∑–º–æ–∂–Ω–æ, –í–∞–º —Å—Ç–æ–∏—Ç –ø—Ä–∏—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è –∫ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Å–Ω–∏–∑–∏—Ç—å —Ç—Ä–∞—Ç—ã.\n\n\t–ü–æ–¥–∫–ª—é—á–µ–Ω—ã –ª–∏ –≤—ã –∫ –Ω–∞—à–µ–º—É –º–æ–±–∏–ª—å–Ω–æ–º—É –æ–ø–µ—Ä–∞—Ç–æ—Ä—É? –£–≤–µ—Ä—è—é –í–∞—Å, —É –Ω–∞—Å —Å–∞–º—ã–µ **–≤—ã–≥–æ–¥–Ω—ã–µ** —Ç–∞—Ä–∏—Ñ—ã –∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ –Ω–æ–º–µ—Ä–∞!'''.format(s, perc)
            elif cat == '–¢—É—Ä–∞–≥–µ–Ω—Ç—Å—Ç–≤–∞':
                message = '''üí∏–í –ø—Ä–æ—à–ª–æ–º –º–µ—Å—è—Ü–µ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ***–¢—É—Ä–∞–≥–µ–Ω—Å—Ç–≤–∞*** –í—ã –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ ***{}*** —Ä—É–±–ª–µ–π - —ç—Ç–æ {}% –æ—Ç –≤—Å–µ—Ö —Ç—Ä–∞—Ç.\n\n\t–ù–æ –∫—Ç–æ –∂–µ –Ω–µ –ª—é–±–∏—Ç –æ—Ç–¥—ã—Ö–∞—Ç—å?\n\n\t–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è —Å –Ω–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–µ–π —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –æ—Ç–¥—ã—Ö, –Ω–æ –∏ –µ—â—ë –∏ **–∑–∞—Ä–∞–±–æ—Ç–æ–∫**!\n\n\t–°–º–æ—Ç—Ä–∏—Ç–µ, –∫–∞–∫ –æ—Ç–¥—ã—Ö–∞—Ç—å –∏ –Ω–µ —Å—á–∏—Ç–∞—Ç—å –¥–µ–Ω—å–≥–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –í–∞—à–µ–≥–æ –±–∞–Ω–∫–∞!'''.format(s, perc)
            else:
                message = '''üí∏–í –ø—Ä–æ—à–ª–æ–º –º–µ—Å—è—Ü–µ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ***{}*** –í—ã –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ ***{}*** —Ä—É–±–ª–µ–π - —ç—Ç–æ {}% –æ—Ç –≤—Å–µ—Ö —Ç—Ä–∞—Ç.\n\n\t–í–æ–∑–º–æ–∂–Ω–æ, –í–∞–º —Å—Ç–æ–∏—Ç –ø—Ä–∏—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è –∫ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Å–Ω–∏–∑–∏—Ç—å —Ç—Ä–∞—Ç—ã.'''.format(cat, s, perc)
            res.append(message)
        if len(res) == 3:
            break
    message = '''üëΩ–¢–∞–∫–∂–µ —Å–æ–≤–µ—Ç—É—é –í–∞–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è –≤–∞—à–∏—Ö —Ç—Ä–∞—Ç.\n\n\t–ù–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–¥–∫–ª—é—á–∏–º –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ 100 —Ä—É–±–ª–µ–π: —Å 10 –ø–æ–∫—É–ø–æ–∫, –Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ 370 —Ä—É–±–ª–µ–π, –í—ã –Ω–∞–∫–æ–ø–∏—Ç–µ ***300*** —Ä—É–±–ª–µ–π!\n\n\t–ù–µ–∑–∞–º–µ—Ç–Ω–æ–µ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –ø–æ–º–æ–∂–µ—Ç –í–∞–º –∑–∞–º–µ—Ç–∏—Ç—å –ø—Ä–∏—è—Ç–Ω—ã–π ***–±–æ–Ω—É—Å*** –≤ –∫–æ–Ω—Ü–µ –º–µ—Å—è—Ü–∞!'''
    res.append(message)
    message = '''üëΩ–ï—Å–ª–∏ —É –í–∞—Å –≤—Å–µ–≥–¥–∞ –æ—Å—Ç–∞—ë—Ç—Å—è —Å—É–º–º–∞ –Ω–∞ —Å—á–µ—Ç—É, –Ω–µ —Å—Ç–µ—Å–Ω—è–π—Ç–µ—Å—å –ø–µ—Ä–µ—á–∏—Å–ª—è—Ç—å –µ—ë –Ω–∞ –≤–∫–ª–∞–¥!\n\n\t–ú—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —Ö–æ—Ä–æ—à–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –∏ –≤–ø–æ—Å–ª–µ–¥—Å–≤–∏–∏ –ø—Ä–∏—è—Ç–Ω—ã–π –ø–∞—Å—Å–∏–≤–Ω—ã–π ***–∑–∞—Ä–∞–±–æ—Ç–æ–∫***!'''
    res.append(message)
    message = '''–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –≤—Å–µ—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö –≤ –º–æ–±–∏–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –≤–∞—à–µ–≥–æ –±–∞–Ω–∫–∞.'''
    res.append(message)
    return res